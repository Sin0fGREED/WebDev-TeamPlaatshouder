services:
  db:
    container_name: oc_db
    image: mcr.microsoft.com/mssql/server:2022-latest
    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=${SA_PASSWORD}
    ports: ["1433:1433"]
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/127.0.0.1/1433' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 15
      start_period: 40s
  api:
    build:
      context: ./server
      dockerfile: src/OfficeCalendar.Api/Dockerfile
    container_name: oc_api
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__Default=Server=db;Database=${DB_NAME};User Id=sa;Password=${SA_PASSWORD};TrustServerCertificate=true
      - Jwt__Issuer=${JWT__Issuer}
      - Jwt__Audience=${JWT__Audience}
      - Jwt__Key=${JWT__Key}
    ports: ["5287:8080"]
    depends_on:
      db:
        condition: service_healthy

  web:
    build:
      context: ./web
      dockerfile: Dockerfile.dev
    container_name: oc_web
    ports: ["5173:5173"]
    environment:
      - VITE_API_BASE=http://localhost:5287
      - VITE_SIGNALR=/hubs/calendar
    volumes:
      - ./web:/usr/src/app
      - /usr/src/app/node_modules
    depends_on:
      - api
